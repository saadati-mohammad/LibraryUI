<div class="chat-wrapper">
    <!-- Header -->
    <div class="chat-header">
        <div class="d-flex" style="align-items: center">
            <button class="header-menu-btn" (click)="toggleHeaderMenu()" [attr.aria-expanded]="showHeaderMenu">
                โ
            </button>
            <div class="profile-Info-Container">
                <div class="profile-pic-container">
                    {{targetUserFarsiTitle.charAt(0)}}{{targetUserFarsiTitle.charAt(1) || ''}}
                </div>
                <div style="color: black">{{targetUserFarsiTitle}}</div>
            </div>
        </div>

        <!-- Connection Status Indicator -->
        <div class="connection-status" [class]="'status-' + (connected ? 'connected' : 'disconnected')">
            <span class="status-dot"></span>
            <span class="status-text">{{connectionStatus}}</span>
        </div>

        <button class="header-menu-btn closeBtn" (click)="closeModal()">โจ
        </button>

        <!-- Header Menu -->
        <div class="header-menu" [class.show]="showHeaderMenu">
            <div class="header-menu-item" (click)="toggleSearch()">
                <span class="context-menu-icon">๐</span>
                <span>ุฌุณุชุฌู</span>
            </div>
            <div class="header-menu-item">
                <span class="context-menu-icon">๐</span>
                <span>ุชูุธูุงุช</span>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section" [class.active]="showSearchSection">
        <div class="search-basic">
            <button class="search-close-btn" (click)="toggleSearch()" title="ุจุณุชู ุฌุณุชุฌู">
                ร
            </button>

            <input type="text" class="search-input" [(ngModel)]="searchQuery" (input)="onSearchInput()"
                placeholder="ุฌุณุชุฌู ุฏุฑ ูพุงูโูุง...">

            <button class="search-btn" (click)="performSearch()">
                ๐
            </button>

            <button class="expand-btn" [class.expanded]="showAdvancedSearch" (click)="toggleAdvancedSearch()">
                <span>{{showAdvancedSearch ? 'ุณุงุฏู' : 'ูพุดุฑูุชู'}}</span>
                <span>{{showAdvancedSearch ? 'โฒ' : 'โผ'}}</span>
            </button>
        </div>

        <!-- Advanced Search -->
        <div class="search-advanced" [class.active]="showAdvancedSearch">

            <div class="search-field">
                <label>ูุฑุณุชูุฏู</label>
                <input type="text" [(ngModel)]="searchSender" (input)="performSearch()"
                    placeholder="ูุงู ูุฑุณุชูุฏู ุฑุง ูุงุฑุฏ ฺฉูุฏ">
            </div>

            <div class="search-field">
                <label>ููุถูุน</label>
                <select [(ngModel)]="searchSubjects" (change)="performSearch()">
                    <option value="">ููู ููุถูุนุงุช</option>
                    <option value="ุงุฎุชุตุงุต">ุงุฎุชุตุงุต</option>
                    <option value="ุนููู">ุนููู</option>
                    <option value="ุฏุฑุฎูุงุณุช">ุฏุฑุฎูุงุณุช</option>
                    <option value="ุงุทูุงุนโุฑุณุงู">ุงุทูุงุนโุฑุณุงู</option>
                    <option value="ูพฺฏุฑ">ูพฺฏุฑ</option>
                    <option value="ุดฺฉุงุช">ุดฺฉุงุช</option>
                    <option value="ูพุดููุงุฏ">ูพุดููุงุฏ</option>
                    <option value="ุณุงุฑ">ุณุงุฑ</option>
                </select>
            </div>

            <div class="search-field">
                <label>ุงูููุช</label>
                <select [(ngModel)]="searchPriority" (change)="performSearch()">
                    <option value="">ููู ุงูููุชโูุง</option>
                    <option value="normal">ุนุงุฏ</option>
                    <option value="high">ููู</option>
                    <option value="urgent">ููุฑ</option>
                </select>
            </div>
        </div>

        <!-- Search Results Info -->
        <div class="search-results-info" [class.show]="hasSearchResults">
            <div>
                ูุชุงุฌ ุฌุณุชุฌู: <span>{{searchResultsCount}}</span> ูพุงู
                <span *ngIf="hasSearchResults">
                    ({{currentSearchPosition}}/{{searchResultsCount}})
                </span>
            </div>
            <div class="search-navigation">
                <button class="search-nav-btn" (click)="goToPreviousSearchResult()"
                    [disabled]="chatState.currentSearchIndex <= 0">
                    โ
                </button>
                <button class="search-nav-btn" (click)="goToNextSearchResult()"
                    [disabled]="chatState.currentSearchIndex >= searchResultsCount - 1">
                    โ
                </button>
                <button class="search-results-list-btn" (click)="showSearchResultsList()">
                    ูุณุช
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" #chatContainer (scroll)="onScroll()">

        <!-- Loading Indicator -->
        <div class="loading-indicator" [style.display]="chatState.loading ? 'block' : 'none'">
            ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูพุงูโูุง ุจุดุชุฑ...
        </div>

        <!-- No More Messages -->
        <div class="no-more-messages" *ngIf="!chatState?.hasMore && (chatState?.messages?.length || 0) > 0">
            ููู ูพุงูโูุง ุจุงุฑฺฏุฐุงุฑ ุดุฏูุฏ โ
        </div>

        <!-- Messages -->
        <div *ngFor="let message of chatState.messages; trackBy: messageTrackBy" class="message"
            [class]="getMessageClasses(message)" [attr.data-message-id]="message.id"
            (contextmenu)="onMessageRightClick($event, message)">

            <!-- Reply Info -->
            <div *ngIf="message.replyTo && !message.deleted" class="reply-info" [attr.data-reply-to]="message.replyTo"
                (click)="scrollToMessage(message.replyTo)">
                <div class="reply-indicator">โช</div>
                <div class="reply-content">
                    <div class="reply-author">{{getReplyAuthor(message.replyTo)}}</div>
                    <div class="reply-text">{{getReplyText(message.replyTo)}}</div>
                </div>
            </div>

            <!-- Message Content -->
            <div class="message-content">
                <span [innerHTML]="getMessageText(message) | safeHtml"></span>
            </div>

            <!-- File Attachment -->
            <div *ngIf="message.file && !message.deleted" class="file-attachment"
                [attr.data-status]="message.file.uploadStatus" [attr.data-file-id]="message.file.id">

                <span class="file-icon">{{message.file.icon}}</span>

                <div class="file-info">
                    <div class="file-name">{{message.file.name}}</div>
                    <div *ngIf="message.file.uploadStatus === 'completed'" class="file-size">
                        {{message.file.size | fileSize}}
                    </div>
                    <div *ngIf="message.file.uploadStatus === 'uploading'" class="upload-status-text">
                        ุฏุฑ ุญุงู ุขูพููุฏ...
                    </div>
                </div>

                <!-- File Actions -->
                <button *ngIf="message.file.uploadStatus === 'completed'" class="file-action-button file-download-btn"
                    (click)="downloadFile(message.file!)" title="ุฏุงูููุฏ">
                    โ
                </button>

                <button *ngIf="message.file.uploadStatus === 'uploading'"
                    class="file-action-button file-cancel-upload-btn" title="ูุบู ุขูพููุฏ">
                    ร
                </button>

                <!-- Upload Progress -->
                <div *ngIf="message.file.uploadStatus === 'uploading'" class="file-progress-container">
                    <div class="progress-bar">
                        <div class="progress-bar-inner" [style.width.%]="message.file.uploadProgress || 0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Tags -->
            <div *ngIf="message?.tags && (message?.tags?.length || 0) > 0 && !message.deleted" class="message-tags">
                <span *ngFor="let tag of message.tags" class="tag">
                    #{{tag}}
                </span>
            </div>

            <div class="message-info-container">
                <!-- Message Info -->
                <div class="message-info">
                    <!-- Message Subject -->
                    <div *ngIf="message.subject && !message.deleted" class="message-subject">
                        ููุถูุน: {{message.subject}}
                    </div>
                    <!-- Priority Badge -->
                    <span *ngIf="message.priority && message.priority !== 'normal' && !message.deleted"
                        class="priority-badge" [class]="'priority-' + message.priority">
                        {{getPriorityLabel(message.priority)}}
                    </span>

                    <!-- Message NationalCode -->
                    <div *ngIf="message.nationalCode && !message.deleted" class="message-nationalCode">
                        ฺฉุฏ ูู: {{message.nationalCode}}
                    </div>

                    <!-- Enable SMS Badge -->
                    <span *ngIf="message.enableSendSms && !message.deleted" class="sms-badge">
                        ๐ฑ ุงุฑุณุงู ูพุงูฺฉ
                    </span>
                </div>

                <!-- Message Time and Status -->
                <div class="message-time-status">
                    <div class="message-time">
                        {{message.time}}
                        <span *ngIf="message.edited"> (ูุฑุงุด ุดุฏู)</span>
                    </div>
                    <!-- Message Status Icon -->
                    <div class="message-status" *ngIf="message.type === 'user' && message.status">
                        <span class="status-icon" [class]="getMessageStatusClass(message.status)"
                            [title]="message.status">
                            {{getMessageStatusIcon(message.status)}}
                        </span>
                        <!-- Retry button for failed messages -->
                        <button *ngIf="message.status === 'failed'" class="retry-btn"
                            (click)="retryFailedMessage(message.id)" title="ุชูุงุด ูุฌุฏุฏ">
                            ๐
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Section -->
    <div class="chat-input-container">

        <!-- File Preview -->
        <div class="file-preview" [class.show]="showFilePreview">
            <div class="file-preview-info">
                <span>๐</span>
                <span>{{selectedFileName}}</span>
            </div>
            <button class="file-preview-remove" (click)="removeSelectedFile()">
                ร
            </button>
        </div>

        <!-- Advanced Inputs -->
        <div class="advanced-inputs" [class.active]="showAdvancedInput">
            <div class="input-grid">
                <div class="input-field">
                    <label>ููุถูุน</label>
                    <select [(ngModel)]="messageSubject">
                        <option value="">ุงูุชุฎุงุจ ููุถูุน</option>
                        <option value="ุงุฎุชุตุงุต">ุงุฎุชุตุงุต</option>
                        <option value="ุนููู">ุนููู</option>
                        <option value="ุฏุฑุฎูุงุณุช">ุฏุฑุฎูุงุณุช</option>
                        <option value="ุงุทูุงุนโุฑุณุงู">ุงุทูุงุนโุฑุณุงู</option>
                        <option value="ูพฺฏุฑ">ูพฺฏุฑ</option>
                        <option value="ุดฺฉุงุช">ุดฺฉุงุช</option>
                        <option value="ูพุดููุงุฏ">ูพุดููุงุฏ</option>
                        <option value="ุณุงุฑ">ุณุงุฑ</option>
                    </select>
                </div>

                <div class="input-field">
                    <label>ุงูููุช</label>
                    <select [(ngModel)]="messagePriority">
                        <option value="normal">ุนุงุฏ</option>
                        <option value="high">ููู</option>
                        <option value="urgent">ููุฑ</option>
                    </select>
                </div>

                <div class="input-field" *ngIf="messageSubject === 'ุงุฎุชุตุงุต'">
                    <label>ฺฉุฏ ูู</label>
                    <input type="number" [(ngModel)]="nationalCode" placeholder="ฺฉุฏ ูู ุฑุง ูุงุฑุฏ ฺฉูุฏ" maxlength="10"
                        pattern="[0-9]{10}">
                </div>

                <div class="input-field">
                    <label>ุงุฑุณุงู ูพุงูฺฉ</label>
                    <input type="checkbox" [(ngModel)]="enableSendSms" id="enableSms">
                    <label for="enableSms" class="checkbox-label">ูุนุงู</label>
                </div>
            </div>
        </div>

        <!-- Edit Preview -->
        <div class="edit-preview" [class.show]="showEditPreview && isEditing">
            <button class="preview-close" (click)="cancelEdit()" title="ุงูุตุฑุงู ุงุฒ ูุฑุงุด">
                ร
            </button>
            <div class="preview-header">
                <span class="edit-icon">โ๏ธ</span>
                <span class="preview-author edit-preview-author">ุฏุฑ ุญุงู ูุฑุงุด ูพุงู</span>
            </div>
            <div class="preview-text">{{getEditingMessageText()}}</div>
        </div>

        <!-- Reply Preview -->
        <div class="reply-preview" [class.show]="showReplyPreview && isReplying">
            <button class="preview-close" (click)="hideReplyPreview()" title="ุงูุตุฑุงู ุงุฒ ูพุงุณุฎ">
                ร
            </button>
            <div class="preview-header">
                <span class="reply-icon">โช</span>
                <span class="preview-author reply-preview-author">
                    ูพุงุณุฎ ุจู {{chatState.replyingToMessage?.author}}
                </span>
            </div>
            <div class="preview-text">
                {{chatState.replyingToMessage?.message}}
            </div>
        </div>

        <!-- Input Controls -->
        <div class="input-controls">
            <button class="expand-input-btn" [class.expanded]="showAdvancedInput" (click)="toggleAdvancedInput()"
                title="ุชูุธูุงุช ูพุดุฑูุชู">
                {{showAdvancedInput ? 'โผ' : 'โฒ'}}
            </button>

            <div class="file-input-btn" title="ุถููู ูุงู">
                ๐
                <input type="file" #fileInput (change)="onFileSelected($event)" accept="*/*">
            </div>

            <div class="input-wrapper">
                <textarea class="chat-input" #chatInput [(ngModel)]="messageText" (keydown)="onInputKeyDown($event)"
                    (input)="autoResizeTextarea()" [placeholder]="getInputPlaceholder()" [disabled]="!connected"
                    rows="1">
        </textarea>

                <!-- ููุงุด ูุถุนุช ุชุงูพ -->
                <div *ngIf="isTyping" class="typing-indicator">
                    <span>{{targetUserFarsiTitle}} ุฏุฑ ุญุงู ุชุงูพ ุงุณุช</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>

            <button class="send-button" [class.editing-mode]="isEditing" [class.reply-mode]="isReplying"
                [disabled]="!isFormValid() || (!connected && !isEditing)" (click)="sendMessage()"
                [title]="getSendButtonTitle()">
                {{getSendButtonIcon()}}
            </button>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" [style.display]="showContextMenu ? 'block' : 'none'" [style.left.px]="contextMenuPosition.x"
    [style.top.px]="contextMenuPosition.y">

    <div class="context-menu-item" (click)="onReplyToMessage()">
        <span class="context-menu-icon"><i class="fa fa-reply"></i></span>
        <span>ูพุงุณุฎ ุจู ูพุงู</span>
    </div>

    <div *ngIf="canEditMessage" class="context-menu-item" (click)="onEditMessage()">
        <span class="context-menu-icon"><i class="fa fa-pencil"></i></span>
        <span>ูุฑุงุด</span>
    </div>

    <div *ngIf="canDeleteMessage" class="context-menu-item danger" (click)="onDeleteMessage()">
        <span class="context-menu-icon"><i class="fa fa-trash"></i></span>
        <span>ุญุฐู</span>
    </div>

    <!-- Forward option -->
    <div class="context-menu-item" (click)="onForwardMessage()">
        <span class="context-menu-icon"><i class="fa fa-forward"></i></span>
        <span>ูุฏุงุช</span>
    </div>

    <!-- Copy option -->
    <div class="context-menu-item" (click)="onCopyMessage()">
        <span class="context-menu-icon"><i class="fa fa-copy"></i></span>
        <span>ฺฉูพ</span>
    </div>
</div>

<!-- Search Results Modal -->
<div class="search-results-modal" [class.show]="showSearchResultsModal">
    <div class="search-results-content">
        <div class="search-results-header">
            <span>ูุชุงุฌ ุฌุณุชุฌู</span>
            <button class="search-results-close" (click)="hideSearchResultsList()">
                ร
            </button>
        </div>
        <div class="search-results-list">
            <div *ngFor="let result of searchResults; let i = index" class="search-result-item"
                (click)="goToSearchResult(i)">
                <div class="search-result-author">{{result.author}}</div>
                <div class="search-result-text">{{result.message}}</div>
                <div class="search-result-time">{{result.time}}</div>
            </div>

            <div *ngIf="searchResults?.length === 0" class="no-results">
                ูฺ ูุชุฌูโุง ุงูุช ูุดุฏ
            </div>
        </div>
    </div>
</div>
<div class="forward-modal" [class.show]="showForwardModal">
    <div class="forward-modal-content">
        <div class="forward-modal-header">
            <span>ูุฏุงุช ูพุงู</span>
            <button class="forward-modal-close" (click)="closeForwardModal()">ร</button>
        </div>

        <div class="forward-message-preview">
            <div class="forward-preview-label">ูพุงู:</div>
            <div class="forward-preview-text">{{selectedMessageForAction?.message}}</div>
        </div>

        <div class="forward-contacts-section">
            <div class="forward-section-title">ุงูุชุฎุงุจ ูุฎุงุทุจู:</div>
            <div class="forward-contacts-list">
                <div *ngFor="let contact of availableContacts" class="forward-contact-item"
                    (click)="toggleContactSelection(contact)">
                    <div class="contact-checkbox">
                        <input type="checkbox" [checked]="selectedContacts.has(contact.username)"
                            (change)="toggleContactSelection(contact)">
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">{{contact.name}}</div>
                        <div class="contact-username">{{contact.username}}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="forward-modal-actions">
            <button class="btn-cancel" (click)="closeForwardModal()">ุงูุตุฑุงู</button>
            <button class="btn-forward" [disabled]="selectedContacts.size === 0" (click)="forwardMessage()">
                ูุฏุงุช ({{selectedContacts.size}})
            </button>
        </div>
    </div>
</div>